Date: 2025-11-23
Version: 2.3.3C "Hardened"

## DESCRIPTION
This release is a major stability overhaul focused on thread safety, resource management, and preventing runtime crashes in long-running applications. It addresses several critical architectural flaws identified in the Audio and Vulkan backends, transforming the library from a prototype into a production-ready framework.

## BREAKING API CHANGES

*   **Audio Loading Strategy:** The signature of `SituationLoadSoundFromFile` has changed.
    *   *Old:* `(path, looping, out_sound)`
    *   *New:* `(path, mode, looping, out_sound)`
    *   *Reason:* Users must now specify `SITUATION_AUDIO_LOAD_AUTO`, `FULL` (RAM decode), or `STREAM` (Disk I/O) to prevent the audio thread from blocking on disk operations.

## CRITICAL STABILITY FIXES

*   **Audio Thread "Death Spiral":** Completely rewrote the audio loading logic. Short sounds (SFX) are now decoded fully to RAM upon load. The audio callback no longer performs blocking disk I/O for these sounds, eliminating stuttering/popping during gameplay or background loading.

*   **Vulkan Descriptor Exhaustion:** Replaced the fixed-size descriptor pool (limit 512) with a **Dynamic Descriptor Manager**. The engine now automatically allocates new pools as needed, allowing for an effectively infinite number of textures and materials.

*   **OpenGL State Leak:** Implemented a "State Guard" in `SituationRenderVirtualDisplays`. The compositor now backs up the active Shader Program, VAO, Texture Units, and Blend Modes before rendering and restores them exactly afterwards. This prevents internal rendering passes from corrupting user rendering state.

*   **Compute Pipeline Crash:** Fixed a severe memory offset bug in `SituationDestroyComputePipeline`. The function was passing a public struct pointer to an internal helper expecting a different memory layout, which would have caused heap corruption or driver crashes on cleanup.

## OPTIMIZATIONS

*   **O(1) Input Processing:** Replaced the `O(N)` memory-shifting queues in the Keyboard, Mouse, and Gamepad subsystems with **Ring Buffers**. Input processing time is now constant regardless of queue depth.

*   **Audio Capture Logic:** Fixed a logic hole in `SituationPollInputEvents` where captured audio data was locked but never dispatched to the user. Added a thread-safe linearization step to correctly pass ring-buffer data to the user callback.

--------------------------------------------------------------------------------

Date: 2025-11-21
Version: 2.3.3B "Refinement"

## DESCRIPTION
This patch release resolves critical compilation errors in the Vulkan backend introduced in 2.3.3A. It solidifies the "Unified Resource" system, ensuring textures and compute pipelines are correctly configured and stable across both backends.

## API CHANGES & IMPROVEMENTS

*   **Unified Texture Creation:** `SituationCreateTexture()` now automatically applies `VK_IMAGE_USAGE_STORAGE_BIT` (Vulkan) and compatible storage flags (OpenGL) to all new textures.
    *   *Impact:* All textures created via the standard API are now "Compute-Ready" by default. Users can bind any texture to a Compute Shader without needing special creation flags or distinct API calls.

## BUG FIXES

*   **Vulkan Compilation:** Resolved an undefined variable error (`usage_flags`) inside `SituationCreateTexture` that prevented the library from compiling when `SITUATION_USE_VULKAN` was defined.

*   **Missing Definitions:** Added the missing `SituationTextureUsageFlags` enum and replaced undefined macros in `_SituationInitVulkan` with defined numeric constants for descriptor pool sizing.

*   **Compute Binding Crash:** Fixed a runtime crash during Vulkan initialization by ensuring the `storage_image_layout` is correctly created. This resolves issues when attempting to bind textures to Compute Shaders.

--------------------------------------------------------------------------------

Date: 2025-11-21
Version: 2.3.3A "Refinement"

## DESCRIPTION
This maintenance release tightens the API surface and improves developer ergonomics. It addresses several "friction points" identified in previous versions, particularly around string handling and file export safety.

## API CHANGES & IMPROVEMENTS

*   **Static Version String:** `SituationGetVersionString()` now returns a pointer to a static, read-only string buffer.
    *   *Impact:* Users no longer need to `free()` the returned pointer, making version logging a simple one-liner: `printf("Situation v%s\n", SituationGetVersionString());`.
    
*   **Strict PNG Screenshots:** `SituationTakeScreenshot()` now strictly enforces the `.png` file extension.
    *   *Impact:* Prevents silent failures or garbage output when users attempt to save with unsupported extensions (like `.jpg` or `.txt`). The function now returns `false` and sets a clear error message if a non-PNG path is provided.
    *   *Cleanup:* The legacy BMP fallback writer has been removed to reduce binary size and maintenance surface area.

*   **Documentation:** Added comprehensive internal documentation for complex Vulkan helpers (e.g., `_SituationVulkanBlitImageToHostVisibleBuffer`) to aid future maintenance and auditing.

## BUG FIXES

*   **VRAM Reporting:** Implemented a multi-backend strategy for `SituationGetVRAMUsage()`. It now supports Windows (DXGI), Vulkan (VMA), and NVIDIA OpenGL extensions, providing accurate memory tracking across a wider range of configurations.

--------------------------------------------------------------------------------

Date: 2025-11-21
Version: 2.3.3 "Insight"

## DESCRIPTION
Version 2.3.3 is a "quality of life" feature release that expands the developer's ability to monitor performance and embed assets. It introduces the "Small but Deadly" feature set: direct memory loading for fonts, formatted text drawing, and hardware profiling hooks.

## NEW FEATURES

*   **Memory Asset Loading:** Added `SituationLoadFontFromMemory`. This allows developers to embed fonts (e.g., using `xxd -i`) directly into their executable for truly single-file distribution, bypassing the filesystem.
*   **Formatted Text:** Added `SituationImageDrawTextFormatted`. This convenience function accepts `printf`-style format strings (e.g., `"Score: %d", score`), eliminating the need for users to manually `snprintf` into temporary buffers before drawing text.
*   **Hardware Info:** Added `SituationGetGPUName()` to retrieve the human-readable model name of the active graphics adapter.

## PROFILING & DIAGNOSTICS

*   **Draw Call Counting:** The engine now tracks the number of draw commands issued per frame. This data is accessible via `SituationGetDrawCallCount()`.
*   **VRAM Monitoring:** On Vulkan, `SituationGetVRAMUsage()` now returns the precise number of bytes allocated by the engine's internal allocator (VMA), allowing for real-time memory budget monitoring.

## INTERNAL IMPROVEMENTS

*   **Quad Renderer Refactor:** The internal 2D quad renderer has been modernized (Phase 2.5 prep). It now supports dynamic UV coordinates via push constants, paving the way for future GPU-accelerated text rendering.
*   **Pipeline Layout Optimization:** Vulkan internal pipelines now use more efficient layout creation strategies, reducing initialization overhead.

--------------------------------------------------------------------------------

Date: 2025-11-20
Version: 2.3.2D "Integrity"

## DESCRIPTION
This is a critical stability release. It addresses a severe race condition in the audio streaming subsystem, plugs memory leaks in the Vulkan swapchain recreation logic, and ensures OpenGL state isolation.

## CRITICAL FIXES

*   **Audio Stream Thread-Safety:** Completely refactored `SituationLoadSoundFromStream`. Previously, a shared global vtable caused race conditions and data corruption when loading multiple streams. This has been replaced with instance-based callback storage and static thunks, ensuring complete isolation and thread safety.
*   **Vulkan Swapchain Leak:** Fixed a memory leak where the `swapchain_images` handle array was not freed during swapchain recreation (e.g., window resize).
*   **OpenGL State Corruption:** `SituationRenderVirtualDisplays` now correctly saves and restores the Depth Test state (`GL_DEPTH_TEST`), preventing it from accidentally enabling depth testing for subsequent 2D rendering passes.

## LOGIC & SAFETY

*   **Vulkan Pipeline Barriers:** Fixed logic that prevented Execution-Only barriers (barriers with 0 access masks but valid stage masks) from being recorded.
*   **Model Loading Safety:** `SituationLoadModel` now validates texture creation. If a texture file is missing, it logs a warning instead of assigning a null ID, preventing silent rendering failures.
*   **Shader Debugging:** Increased the internal error message buffer size (to 2048 bytes) to prevent truncation of complex GLSL compilation errors.
*   **API Clarity:** `SituationCmdSetVertexAttribute` now returns a precise error message on Vulkan, explaining that vertex formats are immutable in that backend.

--------------------------------------------------------------------------------

Date: 2025-11-20
Version: 2.3.2C "Zero Friction"

## DESCRIPTION
This micro-release focuses purely on developer experience and removal of friction. It transforms "Situation" into a true "drop-in" library where advanced features like image loading, screenshots, and text rendering work immediately without external configuration.

## ZERO FRICTION UPDATES

*   **Embedded STB Libraries:** `stb_image`, `stb_image_write`, and `stb_truetype` are now automatically implemented by `SITUATION_IMPLEMENTATION`.
    *   **Impact:** `SituationLoadImage`, `SituationTakeScreenshot(.png)`, and `SituationDrawTextStyled` work out-of-the-box with zero additional defines or includes.
    *   **Opt-Out:** Users can define `SITUATION_NO_STB` (or specific flags like `SITUATION_NO_STB_IMAGE`) to disable this if they manage dependencies externally.

## API ADDITIONS

*   **Version Querying:** Added `SITUATION_VERSION_MAJOR/MINOR/PATCH` macros and `SituationGetVersionString()` for runtime version checking.

## SUMMARY
With 2.3.2C, the "Hello World" for a graphical, audio-enabled application with font support is now literally one C file with two #defines.

--------------------------------------------------------------------------------

Date: 2025-11-20
Version: 2.3.2B "Consistency"

## DESCRIPTION
This hotfix eliminates cross-backend inconsistencies and improves safety. The execution-model difference between OpenGL and Vulkan is now actively enforced in debug builds.

## CRITICAL FIXES & BEHAVIORAL GUARANTEES

*   **Enforced Buffer-Update-Before-Draw Rule:** In OpenGL debug builds, `SituationUpdateBuffer` now triggers a loud warning/error if called *after* any draw command in the current frame. This prevents the most common cause of cross-backend logic divergence.
*   **SituationSetGamepadVibration Return Type:** Now returns `bool` (true on success) instead of `void`. It correctly returns `false` and sets an error on non-Windows platforms.
*   **PNG Screenshots:** `stb_image_write.h` is now automatically implemented if available (unless `SITUATION_NO_STB_PNG` is defined), fixing silent failures when saving PNGs.

## USABILITY

*   **SITUATION_BEGIN_FRAME():** Added a macro to standardize the start of the render loop (`PollInput` + `UpdateTimers`).
*   **Main-Thread Audio Capture:** Added `SITUATION_INIT_AUDIO_CAPTURE_MAIN_THREAD` flag to `SituationInitInfo`. When set, audio capture callbacks are safely routed to the main thread during `SituationPollInputEvents`, preventing threading crashes for users.
*   **Vulkan No-Shaderc Fallback:** Internal 2D renderers now elegantly disable themselves if `SITUATION_ENABLE_SHADER_COMPILER` is not defined, removing the hard dependency on `shaderc` for basic initialization.

## INTERNAL REFACTORING

*   **Vulkan Pipeline Optimization:** Refactored the internal Advanced Compositing pipeline initialization. It now reuses existing descriptor set layouts instead of allocating temporary ones, reducing code size and initialization overhead.

--------------------------------------------------------------------------------

Date: 2025-11-20
Version: 2.3.2A "Hotfix"

## DESCRIPTION

This is a maintenance release addressing critical issues identified in the v2.3.2 "Parity" release. It focuses on correcting data capture logic in Vulkan, improving cross-platform error reporting, and loosening dependency requirements.

## CRITICAL FIXES

*   **Fixed Vulkan Screenshot Source:** `SituationLoadImageFromScreen` (and by extension `SituationTakeScreenshot`) now captures the `current_image_index` instead of `last_presented_image_index`. Previously, taking a screenshot in Vulkan would capture the *previous* frame's output.

*   **Non-Windows Gamepad Error:** `SituationSetGamepadVibration` now properly sets the `SITUATION_ERROR_NOT_IMPLEMENTED` error code on Linux and macOS, rather than failing silently.

*   **Optional Shaderc Dependency:** The `#error` forcing `SITUATION_ENABLE_SHADER_COMPILER` for Vulkan has been removed. Users can now compile the Vulkan backend without `shaderc` if they provide their own pre-compiled SPIR-V pipelines.
    *   *Note:* Disabling the compiler disables the internal 2D renderers (`SituationCmdDrawQuad` and Virtual Displays) on Vulkan, as they rely on runtime GLSL compilation.

## DOCUMENTATION

*   **Execution Model Warning:** Added a critical warning to the documentation regarding the Immediate (OpenGL) vs. Deferred (Vulkan) execution models. Developers are strictly advised to update all buffer data *before* recording draw commands to ensure consistent behavior across backends.

--------------------------------------------------------------------------------

Date: 2025-11-19
Version: 2.3.2 "Parity"

## DESCRIPTION

Version 2.3.2 addresses the major feature gaps identified in previous versions, achieving functional parity between the OpenGL and Vulkan backends, and introducing key new capabilities. This release enables "Advanced Blending" for Vulkan Virtual Displays, adds a complete Audio Capture (Microphone) API, and finalizes the 3D Model Exporting tools. Under the hood, it includes critical fixes for Vulkan synchronization (pipeline barriers), memory safety, and descriptor binding logic.

## NEW FEATURES

*   **Audio Capture API:** Added `SituationStartAudioCapture`, `SituationStopAudioCapture`, and the `SituationAudioCaptureCallback` type. This allows applications to record raw audio data (Mono, 32-bit Float, 44.1kHz) from the system's default input device for real-time processing.

*   **Vulkan Advanced Blending:** Implemented the complex "Copy-Before-Draw" architecture for the Vulkan backend. `SituationRenderVirtualDisplays` now correctly handles advanced blend modes (Overlay, Soft Light, etc.) on Vulkan by copying the swapchain image to a readable texture before rendering, matching the visual fidelity of the OpenGL backend.

*   **3D Model Exporting:** Finalized the `SituationSaveModelAsGltf` utility. This required implementing the previously stubbed `SituationGetMeshData` function to perform geometry readback from the GPU to CPU memory, enabling users to save runtime-generated or modified meshes to standard `.gltf` files.

## IMPROVEMENTS & FIXES

### [CRITICAL] Vulkan Synchronization & Stability
*   **Fixed Buffer Readback Synchronization:** Completely refactored `SituationGetBufferData`. It now uses a new internal helper `_SituationVulkanReadBackBuffer` that correctly inserts `vkCmdPipelineBarrier` commands before and after transfers. This fixes race conditions where the CPU would read stale data before the GPU finished writing.
*   **Fixed Texture Usage Flags:** `SituationCreateTexture` now automatically includes the `VK_IMAGE_USAGE_STORAGE_BIT`. This fixes a crash/validation error when attempting to bind textures as Storage Images in compute shaders (`SituationCmdBindComputeTexture`).
*   **Fixed Memory Leaks in Buffer Updates:** Resolved memory leaks in `SituationUpdateBuffer` where temporary staging buffers were not freed if mapping or command allocation failed.

### [BUG FIXES]
*   **OpenGL Initialization:** Implemented the missing `_SituationInitGLVirtualDisplayRenderer` function. Previously, the OpenGL Virtual Display compositor relied on uninitialized Vertex Array Objects, leading to potential rendering failures.
*   **Vulkan Compute Binding:** Fixed logic in `SituationCmdBindComputeTexture` that ignored the user's `binding` parameter and always bound to index 0.
*   **API Safety:** Explicitly disabled `SituationCmdSetVertexAttribute` on the Vulkan backend (returning `SITUATION_ERROR_NOT_IMPLEMENTED`), as dynamic vertex format changes are architecturally impossible in Vulkan pipelines.

### [REFACTORING]
*   **Internal Helpers:** Refactored massive logic blocks from `SituationGetBufferData` into reusable internal helpers, which allowed `SituationGetMeshData` to share the robust memory readback logic without code duplication.
*   **Documentation:** Added comprehensive header documentation for all new internal helpers (`_SituationVulkanCreateScreenCopyResource`, `_SituationVulkanReadBackBuffer`, etc.) and updated public API headers to reflect the new capabilities.

--------------------------------------------------------------------------------

Date: 2025-10-31
Version: 2.3.1A "Refinement"

## DESCRIPTION

Version 2.3.1A is a significant quality-of-life and performance refinement of the "Base" API. This update focuses on improving API safety, enhancing performance on the Vulkan backend, achieving greater feature parity between backends, and improving documentation clarity. While introducing no new major features, this release makes the existing API more robust, efficient, and easier to use correctly.

## CHANGES & IMPROVEMENTS

### [CRITICAL] API & Main Loop Refinement

*   **Deprecated SituationUpdate():** The monolithic SituationUpdate() function has been deprecated. It encouraged a main loop structure that was less explicit and prone to off-by-one-frame input bugs.

*   **New Main Loop Workflow:** Introduced two new core functions, SituationPollInputEvents() and SituationUpdateTimers().
    -   SituationPollInputEvents() is now the dedicated function for gathering all OS events and updating input state for the current frame.
    -   SituationUpdateTimers() is the dedicated function for advancing all internal clocks, calculating delta time, and updating joystick/gamepad state.

*   **Updated Documentation:** The API documentation has been updated to reflect this new, clearer main loop structure, providing a best-practice example to guide users.

### [PERFORMANCE] Vulkan Backend Enhancements

*   **High-Performance Virtual Display Compositing:** The SituationRenderVirtualDisplays() function on the Vulkan backend has been completely overhauled. It now uses the "Persistent Descriptor Set" pattern, pre-allocating a descriptor set for each virtual display at creation time. This eliminates all runtime descriptor allocation and updates from the main render loop, resulting in a massive performance improvement when compositing many virtual displays.

*   **Unified & Performant Resource Binding:**
    -   Introduced SituationCmdBindDescriptorSet() and SituationCmdBindTextureSet() as the new, primary API for binding buffers and textures.
    -   Deprecated the older, less explicit SituationCmdBindUniformBuffer, SituationCmdBindTexture, and SituationCmdBindComputeBuffer functions, which now wrap the new API.
    -   This change leverages the persistent descriptor set model for ALL buffers and textures, making resource binding a consistently fast, low-overhead operation on Vulkan.

### [BUG FIXES & STABILITY]

*   **Fixed Input System Crash:** Resolved a critical bug where the mouse input callbacks would attempt to use an uninitialized mutex, leading to a crash. The mouse state struct now correctly contains and initializes its mutex, ensuring thread-safe event handling.

*   **Fixed Vulkan Resource Leak:** Corrected a resource leak in the internal Vulkan pipeline creation logic. The VkPipelineLayout is now properly destroyed if the subsequent vkCreateGraphicsPipelines call fails, preventing leaks on shader compilation or linking errors.

### [DOCUMENTATION & API CLARITY]

*   **Detailed Color Function Docs:** The documentation for all color conversion functions (SituationRgbToHsv, SituationColorToYPQ, etc.) and SituationImageAdjustHSV has been significantly expanded to explain the color spaces, parameter ranges, and algorithms used.

*   **Improved Image Drawing Docs:** The documentation for all SituationImageDraw...() functions has been updated to clarify their distinct rendering methods (bitmap vs. SDF), performance characteristics, boundary handling, and alpha blending formulas.

*   **Added API Safety Functions:** Introduced new helper functions to make the library's manual memory management safer and more explicit:
    -   SituationFreeDisplays() for correctly deallocating the complex SituationDisplayInfo array.
    -   SituationFreeString() as the designated function for freeing strings returned by the library.
    -   Documentation for all functions that return heap-allocated data now explicitly points to these new, safe deallocation functions.

## KNOWN ISSUES & FEATURE GAPS

*   **Vulkan Advanced Blending:** The Vulkan backend's SituationRenderVirtualDisplays function currently only supports simple blend modes (Alpha, Additive, etc.). The complex, multi-pass logic required for advanced Photoshop-style blend modes (Overlay, Soft Light), which is fully implemented in the OpenGL backend, remains a feature gap. This will be addressed in a future update.

--------------------------------------------------------------------------------

Date: 2025-10-18
Version: 2.3.1 "Base"

## Description

Version 2.3.1, designated as the "Base" version, establishes the foundational public API for the "Situation" library. This release provides a single-file, cross-platform C/C++ library designed to abstract low-level system interactions for windowing, graphics, audio, and input. The primary goal of this version is to offer a stable, lean, and powerful foundation for building sophisticated, high-performance software, such as games, creative coding projects, and data visualization tools.

## Scope & Key Features

This version includes a comprehensive feature set across several core domains:

*   **Lifecycle & Windowing:** Full application lifecycle management (`SituationInit`, `SituationShutdown`) and robust window controls (fullscreen, borderless, multi-monitor awareness) via a GLFW3 backend.
*   **Dual Graphics Backend:** A unified graphics API with compile-time support for both modern OpenGL (4.6+ Core) and Vulkan (1.1+). This includes abstractions for shaders, meshes, textures, and generic buffers.
*   **Command Buffer Model:** A core architectural feature for recording rendering and compute commands. This provides a modern, explicit model for GPU interaction, inspired by Vulkan.
*   **Compute Shaders:** A unified API for GPGPU tasks, supporting both OpenGL Compute Shaders and Vulkan Compute Pipelines, with runtime GLSL-to-SPIR-V compilation via `shaderc`.
*   **2D & 3D Rendering:** High-level helpers for drawing 2D primitives (quads) and textured sprites, alongside a robust system for rendering 3D meshes. Includes a Virtual Display system for off-screen rendering, UI layering, and post-processing.
*   **Audio System:** A full-featured audio engine powered by `miniaudio`, supporting playback, capture, device enumeration, and a real-time effects chain (Filters, Echo, Reverb) with support for custom DSP callbacks.
*   **Input Handling:** Unified polling and event-based handling for keyboard, mouse, and gamepads.
*   **Timing System:** Includes high-resolution timers, FPS management, and an advanced "Temporal Oscillator System" for creating rhythmically synchronized events.
*   **Filesystem Utilities:** A cross-platform API for path manipulation and file I/O, including access to standard application directories.

## Implementation Details

*   **Header-Only Library:** The library is distributed as a single header file (`situation.h`). The implementation is included by defining `SITUATION_IMPLEMENTATION` in one C/C++ file.
*   **Dependencies:**
    *   **Required:** GLFW3, cglm.
    *   **Optional (Backend-Specific):** GLAD (for OpenGL), Vulkan SDK (for Vulkan).
    *   **Optional (Features):** `stb_image`, `stb_truetype`, `miniaudio`.
*   **Resource Management:** The library follows an explicit, manual resource management philosophy. All resources created with `SituationCreate*` or `SituationLoad*` functions must be manually destroyed with their corresponding `SituationDestroy*` or `SituationUnload*` functions. The library includes leak detection at shutdown to assist developers.

## Quirks & Notable Design Decisions

*   **[CRITICAL] Single-Threaded API:** All `SITAPI` functions **must** be called from the main thread (the thread that called `SituationInit`). The library is not internally synchronized, and calling API functions from other threads will lead to undefined behavior and likely crashes. Any multithreading must be managed by the client application, with communication back to the main thread for any API calls.
*   **[CRITICAL] Emulated OpenGL Command Buffer:** While the API presents a unified command buffer model, its execution differs significantly between backends. On Vulkan, commands are deferred and executed upon `SituationEndFrame()`. On OpenGL, the command buffer is an *emulation*, and `SituationCmd*` calls often translate to immediate OpenGL API calls. Developers must not write code that depends on the deferred execution of commands when using the OpenGL backend.
*   **Explicit Backend Selection:** The graphics backend (OpenGL or Vulkan) must be selected at compile time by defining either `SITUATION_USE_OPENGL` or `SITUATION_USE_VULKAN`.
*   **Manual Memory Management for Returned Data:** Functions that return dynamically allocated data (e.g., `SituationGetLastErrorMsg()`, `SituationGetDisplays()`) explicitly state that the caller is responsible for freeing the memory to prevent leaks.
